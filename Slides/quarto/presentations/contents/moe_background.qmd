# Switching Control with Deep-net Mixture of Experts

# Background
* Contact Modeling with Linear Complementarity Formulation  
* Mixture of Experts 

## Contact Modeling

* **Objective**: accurately model contacts, impacts and Coulomb friction.

:::{.fragment fragment-index=0}
* E.g. Model of bouncing ball
:::

:::{.fragment .fade-in fragment-index=1}
* Event detection searches for zero-crossings of the gap function
* It fails during rapid contact
:::

:::{.fragment .fade-in-then-out fragment-index=0}
![](contents/assets/bouncing_ball.jpg){.absolute top=300 left=350 width="400" height="300"}
:::

:::{.fragment .fade-in fragment-index=1}
![](contents/assets/bouncing_ball_event-driven_vs_time_stepping.png){.absolute top=320 left=300 width="450" height="350"}
:::

## Linear Complementarity Formulation {auto-animate=true}

:::{.fragment fragment-index=0}
* Suppose we have a system with $k$ potential contacts.
* $x = (q, \dot{q})$, where $q \in \mathbb{R}^m$ is position vector.
:::

:::{.fragment fragment-index=1}
* $\lambda_N \in \mathbb{R}^k$ denotes normal contact forces, $\lambda_T \in \mathbb{R}^k$ denotes tangential contact force (Coulomb friction)
:::

:::{.fragment .fade-in fragment-index=2}
* Geometric and kinematic constraints are defined as follows:
:::

:::{.fragment .fade-in fragment-index=3}
- $g_N \in \mathbb{R}^k$ denotes normal distance between contact surfaces
:::

::: {.r-stack}

:::{.fragment .fade-in-then-out fragment-index=4}
- $\gamma_N(q, \dot{q}) = \frac{\partial g_N}{\partial t}$ is the relative 
normal velocities
:::

:::{.fragment .fade-in-then-out fragment-index=5}
- $\gamma_N(q, \dot{q}) = \frac{\partial g_N}{\partial q} \dot{q}$ is the relative normal velocities
:::

:::{.fragment .fade-in fragment-index=6}
- $\gamma_N(q, \dot{q}) = W_N \dot{q}$ is the relative normal velocities 
:::

:::

:::{.fragment .fade-in fragment-index=7}
- $\gamma_T(q, \dot{q}) = W_T \dot{q}$ is the relative tangential velocities
:::


## Dynamic constraints

<br/>

* Model of contact dynamics: manipulator equations

\begin{align*}
  \begin{gathered}
    M(q) \ddot{q} + h(q, \dot{q}) - W_N \lambda_N - W_T \lambda_T = 0, \\
    h(q, \dot{q}) = C(q, \dot{q})\dot{q} + G(q) - Bu(q, \dot{q}), 
  \end{gathered}
\end{align*}

:::{.fragment .fade-in fragment-index=0}
* Notice $\ddot{q}$ is does not exist during impacts
:::

:::{.fragment .fade-in fragment-index=1}
* (Moreau 1988) provides compact dynamical model which includes impact as 
\begin{align*}
M(q) \dd \dot{q} + h(q, \dot{q}) \dd t - \dd R = 0, \\
\dd R = W_N \dot{\lambda}_N \dd t + W_T \dot{\lambda}_T \dd t.
\end{align*}

* We integrate these equations via Moreau's time stepping algorithm
:::

## Complementarity Formulation

* For potential contacts with gaps $g_N \leq 0$, the following holds.

\begin{align*}
  \begin{gathered}
    0 \leq 
    \begin{pmatrix}
      \xi_N(q, \dot{q}) \\
      \xi_T(q, \dot{q})
    \end{pmatrix} 
    \perp
      \begin{pmatrix}
        \lambda_N  \\
        \lambda_T
      \end{pmatrix} \geq 0, \\
  % \end{eqnarray}
  % \begin{eqnarray}
    \begin{pmatrix}
      \xi_N(q, \dot{q}) \\
      \xi_T(q, \dot{q})
    \end{pmatrix} :=
      \begin{pmatrix}
        \gamma_N^+ + \epsilon_N \gamma_N^-  \\
        \gamma_T^+ + \epsilon_T \gamma_T^-
      \end{pmatrix},
  \end{gathered}
\end{align*}

:::{.fragment fragment-index=0}
<!-- ::: {.callout} -->

| Scenario | $g_N$ | $\gamma_N^-$ | $\gamma_N^+$ | $\xi_N$ | $\lambda_N$|
|:-----:|:---:|:---:|:---:|:---:|:---:|
| No contact | $g_N \leq 0$ | $\gamma_N > 0$ | $\gamma_N$ | $(I_k +\epsilon_N)\gamma_N$ | $0$ |
| Contact or impact | $g_N \leq 0$ | $\gamma_N \leq 0$ | $- \epsilon_N \gamma_N$ | $0$ | $\lambda_N \geq 0$ |

<!-- ::: -->
:::


## Moreau's Time-Stepping {auto-animate="true"}

\begin{algorithm}
  \Input{$x_0$}
\end{algorithm}


## Mixture of Experts (MOE): Old Faithful {auto-animate="true"}


* **Objective**: learn two expert Gaussian models to predict duration given waiting time

::::{.columns}

<!-- :::{.r-stack} -->

:::{.column  width="50%"}

:::{.fragment .fade-in fragment-index=0}
* The experts are chosen as
$$
F(x;\theta) = \{\mathcal{N}_1(\mu_1, \sigma_1), \mathcal{N}_2(\mu_2, \sigma_2)\}
$$
:::
:::{.fragment .fade-in fragment-index=1}

* The gating network is a neural net $\mathbf{P}(x | \psi) = [P_1(x | \psi), P_2(x | \psi) ]$
:::
:::{.fragment .fade-in fragment-index=2}
* Learn the parameters $\theta = \{(\mu_1, \sigma_1), (\mu_2, \sigma_2) \}$ and $\psi$ from dataset
$\mathbb{D} = \{(x_1, y_1), \dots, (x_N, y_N) \}$
:::
:::


:::{.column  width="50%"}
![](contents/assets/old_faithful.png){.absolute top=100 left=600 width="550" height="400"}
:::

::::

:::{.fragment .fade-in fragment-index=3}
* *Expectation Maximization*: maximizes log likelihood
$$
\ln \{P(\mathbb{D} | \theta, \psi) \} = \sum_{j=1}^{N} \ln \sum_{i=1}^{N_F} \frac{1}{\sqrt{2 \pi \sigma_i^2}} \exp \left( -\frac{1}{2}\frac{(y_j - \mu_i)^2}{\sigma_i^2} \right) P_i(x_j, \psi)
$$
:::

## Generalization of the log likelihood

* The experts can take many forms. The likelihood can be generalized as

:::{.r-stack}

:::{.fragment .fade-in-then-out fragment-index=0}
$$
  \ln \{P(\mathbb{D} | \theta, \psi) \} = \sum_{j=1}^{N} \ln \sum_{i=1}^{N_F} \mathcal{N} ( \| F_i(x_j; \theta_i) - y_j \| \; | \; 0, s)  P_i(x_j, \psi),
$$
:::

:::{.fragment .fade-in fragment-index=1}
$$
  \ln \{P(\mathbb{D} | \theta, \psi) \} = \sum_{j=1}^{N} \ln \sum_{i=1}^{N_F} \frac{1}{\sqrt{2 \pi s^2}} \exp \left( -\frac{1}{2}\frac{ \|F_i(x_j; \theta_i) - y_j \|^2}{s^2} \right) P_i(x_j, \psi),
$$
:::
:::

:::{.fragment .fade-in fragment-index=2}
* For gradient-based techniques, we can extract the relevant parts and simplify the likelihood
$$
  \ln \{P(\mathbb{D} | \theta, \psi) \} \propto \mathbb{L}(\mathbb{D} | \theta, \psi) = \sum_{j=1}^{N} \sum_{i=1}^{N_F} - \| F_i(x_j; \theta_i) - y_j \|^2 P_i(x_j | \psi). 
$$
:::

:::{.fragment .fade-in fragment-index=3}
:::{.callout-note icon=false}
## Likelihood
$$
\mathbb{L}(\mathbb{D} | \theta, \psi) = \sum_{j=1}^{N} \sum_{i=1}^{N_F} - \| F_i(x_j; \theta_i) - y_j \|^2 P_i(x_j | \psi). 
$$
:::
:::
